<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Management System</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Add Tesseract.js library for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>News Management System</h1>
            <nav>
                <button id="reporterBtn" class="nav-btn active">Reporter</button>
                <button id="editorBtn" class="nav-btn">Editor</button>
                <button id="adminBtn" class="nav-btn">Admin</button>
            </nav>
        </header>

        <!-- Reporter Section -->
        <div id="reporterSection" class="section active">
            <div class="reporter-tabs">
                <button id="writeStoryTab" class="tab-btn active">Write Story</button>
                <button id="myStoriesTab" class="tab-btn">My Stories</button>
            </div>

            <!-- Write Story Tab -->
            <div id="writeStoryContent" class="tab-content active">
                <h2>Submit Your Story</h2>
                <form id="storyForm" class="story-form">
                    <div class="form-group">
                        <label for="reporterName">Reporter Name:</label>
                        <input type="text" id="reporterName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="storyTitle">Story Title:</label>
                        <input type="text" id="storyTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="storyContent">Story Content:</label>
                        <textarea id="storyContent" rows="10" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="storyImage">Upload Image:</label>
                        <input type="file" id="storyImage" accept="image/*">
                        <div id="imagePreview" class="image-preview"></div>
                        <!-- AI Story Generation Button -->
                        <button type="button" id="generateStoryBtn" class="generate-btn" style="display: none; margin-top: 10px;">
                            âœ¨ Generate Story from Image
                        </button>
                        <div id="generationStatus" class="generation-status"></div>
                    </div>
                    
                    <button type="submit" class="submit-btn">Submit Story</button>
                </form>
            </div>

            <!-- My Stories Tab -->
            <div id="myStoriesContent" class="tab-content">
                <h2>My Stories</h2>
                <div id="reporterStories" class="stories-list"></div>
            </div>
        </div>

        <!-- Editor Section -->
        <div id="editorSection" class="section">
            <div class="login-form" id="editorLogin">
                <h2>Editor Login</h2>
                <input type="text" id="editorUsername" placeholder="Username">
                <input type="password" id="editorPassword" placeholder="Password">
                <button onclick="editorAuth()">Login</button>
            </div>
            
            <div id="editorContent" class="editor-content" style="display: none;">
                <h2>Story Review Dashboard</h2>
                <div id="editorStories" class="stories-list"></div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="section">
            <div class="login-form" id="adminLogin">
                <h2>Admin Login</h2>
                <input type="text" id="adminUsername" placeholder="Username">
                <input type="password" id="adminPassword" placeholder="Password">
                <button onclick="adminAuth()">Login</button>
            </div>
            
            <div id="adminContent" class="admin-content" style="display: none;">
                <h2>Admin Dashboard</h2>
                <button onclick="clearAllStories()" class="danger-btn">Clear All Stories</button>
                <div id="adminStories" class="stories-list"></div>
            </div>
        </div>
    </div>

    <!-- Edit Story Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Story</h2>
            <form id="editStoryForm">
                <div class="form-group">
                    <label for="editReporterName">Reporter Name:</label>
                    <input type="text" id="editReporterName" required>
                </div>
                
                <div class="form-group">
                    <label for="editStoryTitle">Story Title:</label>
                    <input type="text" id="editStoryTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="editStoryContent">Story Content:</label>
                    <textarea id="editStoryContent" rows="10" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editStoryImage">Update Image:</label>
                    <input type="file" id="editStoryImage" accept="image/*">
                    <div id="editImagePreview" class="image-preview"></div>
                </div>
                
                <button type="submit" class="submit-btn">Update Story</button>
            </form>
        </div>
    </div>

    <script>
        // ===== AI STORY GENERATION FUNCTIONS =====
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupAIStoryGeneration();
        });
        
        function setupAIStoryGeneration() {
            const storyImageInput = document.getElementById('storyImage');
            const generateStoryBtn = document.getElementById('generateStoryBtn');
            const storyContentTextarea = document.getElementById('storyContent');
            const imagePreview = document.getElementById('imagePreview');
            const statusDiv = document.getElementById('generationStatus');
            const storyTitleInput = document.getElementById('storyTitle');
            
            // Show generate button when image is selected
            storyImageInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    generateStoryBtn.style.display = 'block';
                    
                    // Preview image
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; margin-top: 10px;">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    generateStoryBtn.style.display = 'none';
                    imagePreview.innerHTML = '';
                }
            });
            
            // Handle story generation
            generateStoryBtn.addEventListener('click', async function() {
                const file = storyImageInput.files[0];
                if (!file) {
                    alert('Please select an image first.');
                    return;
                }
                
                generateStoryBtn.disabled = true;
                generateStoryBtn.textContent = "Generating...";
                statusDiv.textContent = "Analyzing image...";
                statusDiv.style.color = "#007bff";
                
                try {
                    // Step 1: Extract text from image using OCR
                    statusDiv.textContent = "Extracting text from image...";
                    const extractedText = await extractTextFromImage(file);
                    
                    // Step 2: Generate story using AI
                    statusDiv.textContent = "Creating story with AI...";
                    const { story, title } = await generateAIStory(extractedText);
                    
                    // Step 3: Fill in the story and title
                    storyContentTextarea.value = story;
                    if (title && !storyTitleInput.value) {
                        storyTitleInput.value = title;
                    }
                    
                    statusDiv.textContent = "âœ“ Story generated successfully!";
                    statusDiv.style.color = "#28a745";
                    generateStoryBtn.textContent = "ðŸ”„ Regenerate Story";
                    
                } catch (error) {
                    console.error('Story generation failed:', error);
                    statusDiv.textContent = "âœ— Error: " + error.message;
                    statusDiv.style.color = "#dc3545";
                    alert('AI generation failed. Please write your story manually or try another image.');
                } finally {
                    generateStoryBtn.disabled = false;
                }
            });
        }
        
        // Function to extract text from image using Tesseract.js
        async function extractTextFromImage(imageFile) {
            return new Promise((resolve, reject) => {
                Tesseract.recognize(
                    imageFile,
                    'eng', // English language
                    {
                        logger: info => console.log(info) // Remove this in production
                    }
                ).then(({ data: { text } }) => {
                    const cleanedText = text.trim().replace(/\s+/g, ' ');
                    // If no text found, describe the image
                    if (!cleanedText || cleanedText.length < 5) {
                        resolve("This image contains a visual scene that could be used for a news story. Consider elements like location, people, objects, and activities shown.");
                    } else {
                        resolve(cleanedText);
                    }
                }).catch(reject);
            });
        }
        
        // Function to generate AI story using free API
        async function generateAIStory(imageDescription) {
            try {
                // First try with a free AI API (Hugging Face inference API)
                const story = await generateWithHuggingFace(imageDescription);
                return story;
            } catch (error) {
                console.log("Primary API failed, using fallback:", error);
                // Fallback to simulated AI if API fails
                return generateFallbackStory(imageDescription);
            }
        }
        
        // Using Hugging Face's free inference API (no key required for some models)
        async function generateWithHuggingFace(imageDescription) {
            const prompt = `Write a compelling news article based on this image description: "${imageDescription}". 
            The article should be 150-200 words, include a catchy headline, and follow journalistic style. 
            Structure: Headline, Byline, Lead paragraph, Body with details, and Concluding paragraph.`;
            
            try {
                // Using a public model (this may have rate limits)
                const response = await fetch('https://api-inference.huggingface.co/models/gpt2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_length: 500,
                            temperature: 0.7,
                            do_sample: true
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data[0] && data[0].generated_text) {
                    const fullText = data[0].generated_text;
                    // Extract headline (first line) and story
                    const lines = fullText.split('\n').filter(line => line.trim());
                    const title = lines[0] ? lines[0].replace(/^["']|["']$/g, '') : "Breaking News Story";
                    const story = lines.slice(1).join('\n') || fullText;
                    
                    return { story, title };
                } else {
                    throw new Error("Invalid response from AI service");
                }
                
            } catch (error) {
                console.warn("Hugging Face API error:", error);
                throw error; // Propagate to use fallback
            }
        }
        
        // Fallback function if API is unavailable
        function generateFallbackStory(imageDescription) {
            // Create a structured news story based on image description
            const headlines = [
                "Breaking: Major Development Unfolds",
                "Exclusive Report: Scene Analysis",
                "News Update: Visual Story Uncovered",
                "Report: Image Reveals Intriguing Details"
            ];
            
            const title = headlines[Math.floor(Math.random() * headlines.length)];
            
            const story = `FOR IMMEDIATE RELEASE

${title}

By: AI News Assistant

Based on analysis of the uploaded image, our AI system has generated the following news report:

The visual content depicts ${imageDescription.toLowerCase()}. This scene presents potential news value across multiple dimensions that warrant journalistic attention.

Initial observations suggest noteworthy elements that could form the basis of a developing story. The composition and elements visible in the imagery indicate circumstances that may have broader implications or human interest angles.

Further investigation would be required to verify specific details, but the visual evidence provides a starting point for news development. Key aspects that stand out include contextual elements that suggest potential narrative directions for reporters to pursue.

In conclusion, while AI analysis can identify visual elements and suggest story angles, human journalists remain essential for verifying facts, conducting interviews, and providing the nuanced understanding that transforms visual data into compelling journalism.

[Note: This story was AI-generated based on image analysis. Journalists should verify all facts and add original reporting.]`;

            return { story, title };
        }
        
        // ===== EXISTING NEWS SYSTEM FUNCTIONS =====
        // (Your existing JavaScript functions would go here)
        // I'll include a minimal version to keep the page functional
        
        let stories = JSON.parse(localStorage.getItem('newsStories')) || [];
        let currentUser = '';
        
        // Navigation
        document.getElementById('reporterBtn').addEventListener('click', () => showSection('reporter'));
        document.getElementById('editorBtn').addEventListener('click', () => showSection('editor'));
        document.getElementById('adminBtn').addEventListener('click', () => showSection('admin'));
        
        // Tab switching for reporter
        document.getElementById('writeStoryTab').addEventListener('click', () => showTab('writeStory'));
        document.getElementById('myStoriesTab').addEventListener('click', () => showTab('myStories'));
        
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected section
            document.getElementById(`${section}Section`).classList.add('active');
            document.getElementById(`${section}Btn`).classList.add('active');
        }
        
        function showTab(tab) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(`${tab}Content`).classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
        }
        
        // Story submission
        document.getElementById('storyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const story = {
                id: Date.now(),
                reporter: document.getElementById('reporterName').value,
                title: document.getElementById('storyTitle').value,
                content: document.getElementById('storyContent').value,
                image: document.getElementById('storyImage').files[0] ? 
                       URL.createObjectURL(document.getElementById('storyImage').files[0]) : null,
                date: new Date().toLocaleString(),
                status: 'pending'
            };
            
            stories.push(story);
            localStorage.setItem('newsStories', JSON.stringify(stories));
            
            alert('Story submitted successfully!');
            this.reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('generateStoryBtn').style.display = 'none';
            document.getElementById('generationStatus').textContent = '';
        });
        
        // Load reporter stories
        function loadReporterStories() {
            const reporterStories = stories.filter(s => s.reporter === currentUser);
            const container = document.getElementById('reporterStories');
            container.innerHTML = reporterStories.map(story => `
                <div class="story-card">
                    <h3>${story.title}</h3>
                    <p><strong>Status:</strong> ${story.status}</p>
                    <p><strong>Date:</strong> ${story.date}</p>
                    <p>${story.content.substring(0, 100)}...</p>
                </div>
            `).join('');
        }
        
        // Simple auth functions (for demo)
        function editorAuth() {
            const user = document.getElementById('editorUsername').value;
            const pass = document.getElementById('editorPassword').value;
            
            if (user === 'editor' && pass === 'editor123') {
                document.getElementById('editorLogin').style.display = 'none';
                document.getElementById('editorContent').style.display = 'block';
                loadEditorStories();
            } else {
                alert('Invalid credentials');
            }
        }
        
        function adminAuth() {
            const user = document.getElementById('adminUsername').value;
            const pass = document.getElementById('adminPassword').value;
            
            if (user === 'admin' && pass === 'admin123') {
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadAdminStories();
            } else {
                alert('Invalid credentials');
            }
        }
        
        function loadEditorStories() {
            const container = document.getElementById('editorStories');
            container.innerHTML = stories.map(story => `
                <div class="story-card">
                    <h3>${story.title}</h3>
                    <p><strong>Reporter:</strong> ${story.reporter}</p>
                    <p><strong>Status:</strong> ${story.status}</p>
                    <p><strong>Date:</strong> ${story.date}</p>
                    <p>${story.content.substring(0, 150)}...</p>
                    <button onclick="approveStory(${story.id})">Approve</button>
                    <button onclick="rejectStory(${story.id})">Reject</button>
                </div>
            `).join('');
        }
        
        function loadAdminStories() {
            const container = document.getElementById('adminStories');
            container.innerHTML = stories.map(story => `
                <div class="story-card">
                    <h3>${story.title}</h3>
                    <p><strong>Reporter:</strong> ${story.reporter}</p>
                    <p><strong>Status:</strong> ${story.status}</p>
                    <p><strong>Date:</strong> ${story.date}</p>
                </div>
            `).join('');
        }
        
        function approveStory(id) {
            const story = stories.find(s => s.id === id);
            if (story) {
                story.status = 'approved';
                localStorage.setItem('newsStories', JSON.stringify(stories));
                loadEditorStories();
            }
        }
        
        function rejectStory(id) {
            const story = stories.find(s => s.id === id);
            if (story) {
                story.status = 'rejected';
                localStorage.setItem('newsStories', JSON.stringify(stories));
                loadEditorStories();
            }
        }
        
        function clearAllStories() {
            if (confirm('Are you sure you want to clear all stories?')) {
                stories = [];
                localStorage.removeItem('newsStories');
                loadAdminStories();
            }
        }
        
        // Initialize
        showSection('reporter');
        showTab('writeStory');
    </script>
    
    <style>
        /* Add styles for the AI features */
        .generate-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .generation-status {
            min-height: 20px;
            margin-top: 8px;
            font-style: italic;
            font-size: 14px;
            padding: 5px;
            border-radius: 3px;
            background-color: #f8f9fa;
        }
        
        .image-preview img {
            border-radius: 5px;
            border: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Existing styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
        
        .nav-btn {
            padding: 10px 20px;
            margin-left: 10px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px;
        }
        
        .nav-btn.active {
            background: #007bff;
            color: white;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .reporter-tabs {
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
        }
        
        .tab-btn.active {
            background: #007bff;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .story-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .submit-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .submit-btn:hover {
            background: #218838;
        }
        
        .login-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .login-form input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .login-form button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .stories-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .story-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .story-card h3 {
            margin-top: 0;
            color: #333;
        }
        
        .danger-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
        }
        
        .close {
            float: right;
            font-size: 28px;
            cursor: pointer;
        }
    </style>
</body>
</html>